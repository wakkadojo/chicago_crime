{% extends "base.html" %}
{% block content %}

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- for d3 legends -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <!-- for chromatic/cts color scale -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <!-- for utility functions -->
    <script src="static/js/d3viz/util.js"></script>
    
    <!-- Post Content -->
    <article>
      <div class="container">
        <div class="row">
          <!-- <div class="col-lg-8 col-md-10 mx-auto"> -->
          <div class="col-md-10 mx-auto">

<p style="color: red;">Dont forget to turn off debug flask</p>

<!-- TODO: migrate style touches! --> 
<style> 
.d3axis { 
    font-size: 14px; 
    font-weight: 300; 
}

.autotext { 
    font-size: 16px; 
    font-weight: 300; 
    line-height: 1.4;
}

.map_legend_area { 
    fill: url(#gradient_fill_map_legend); 
    stroke-width: 0px; 
}

#crime_top_bot_summary_tbl td, th { 
    text-align: left; 
}

#tbl_top_bot_start_year,
#tbl_top_bot_end_year {
    text-indent: 2.0em;
}

#crime_top_bot_summary_tbl th + th, 
#crime_top_bot_summary_tbl th + td, 
#crime_top_bot_summary_tbl td + td { 
    text-align: center; 
}

.tbl_container {
    width: 600; 
    margin-left: auto; 
    margin-right: auto; 
    display: table; 
    table-layout: fixed; 
    border-top: 0.75px solid black; 
    border-bottom: 0.75px solid black;
}

.tbl_header {
    font-size: 14px;
    font-weight: bold;
    border-bottom: 1.5px solid black;
}

.archetype_name_tbl 
.archetype_description_tbl {
    font-size: 14px;
}

</style>

<h2 class="section-heading">Summary</h2>

<p>
While crime in Chicago has generally decreased dramatically over the last 15 years, how is the progress distributed among the population? How is it distributed among the type of crime? These questions are the motivation for the investigations outlined below, where we analyze overall crime through time in the city, the "crime inequality" itself, and how the "crime inequality" in the city as varied since the early 2000's.
<p>

<p>
We measure "Crime Intensity" in Chicago since 2002 broken into its major categories: Property Crime, Violent Crime, and Crime Against Society. We will soon elaborate more on "Crime Intensity," but for now think of it as:
</p>
 <blockquote style="text-align: center;">Crime Intensity = (# years served) / person if average prison sentence served in full for every crime reported</blockquote>

<p>
In line with the generally known reduction in crime, this analysis indeed shows a decline in crime by a marked 30% over the last 15 years (though there has also been a slight resurgence over the last few years). This is largely due to a decrease in Property Crime and Crimes against Society; Violent Crimes have remained closer to their 2002 levels. Feel free to explore the data in the figure below.
</p>

            <svg width="600" height="600" id="crime_type_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <script type="text/javascript" src="static/js/d3viz/crime_type_summary.js"></script>

<p>
However, while crime has fallen, it has not fallen uniformly throughout the city. In fact, those feeling the worst crime are feeling a higher fraction now than they have in the past. By looking at how crime is distributed geographically throughout the city, we can get a sense of how concentrated crime is over time. 
</p>

<p>
Again, the nature of this measurement will be elaborated below, but the signal can be seen when clearly looking at how much crime is felt by the worst quartile (worst 25%) as compared to the safest quartile. Among all crimes ("Total") since 2002, crime concentration among the worst areas went from 4.5x that of the safest areas to 5.5x. This was driven by an increase in crime inequality across the board (there was no single category driver).
</p>

<p>
This can be explored in the figure below by clicking the different categories in the legend.
</p>
<p style="color: red;">
Most change from 2002 - 2007 then plateau
</p>
            
            <svg width="600" height="300" id="crime_top_bot_timeseries_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <table id="crime_top_bot_summary_tbl" cellpadding="5" class="d3axis tbl_container">
            <tr>
                <td></td>
                <td colspan=4 style="text-align: center;">
                Ratio of (crime in most severe 25%) to (crime in least severe 25%)
                </td>
            </tr>
            <tr id="top_bot_tbl_header" style="border-bottom: 1.5px solid black;">
                <th></th>
                <th id="Property_tbl_column">Property</th>
                <th id="Society_tbl_column">Society</th>
                <th id="Violent_tbl_column">Violent</th>
                <th id="Total_tbl_column">Total</th>
            </tr>
            <tr id="top_bot_tbl_change">
                <th>Change</th>
                <td id="Property_tbl_column"></td>
                <td id="Society_tbl_column"></td>
                <td id="Violent_tbl_column"></td>
                <td id="Total_tbl_column"></td>
            </tr>
            <tr id="top_bot_tbl_endpoint">
                <th id="tbl_top_bot_end_year">&nbsp;</th>
                <td id="Property_tbl_column"></td>
                <td id="Society_tbl_column"></td>
                <td id="Violent_tbl_column"></td>
                <td id="Total_tbl_column"></td>
            </tr>
            <tr id="top_bot_tbl_start">
                <th id="tbl_top_bot_start_year">&nbsp;</th>
                <td id="Property_tbl_column"></td>
                <td id="Society_tbl_column"></td>
                <td id="Violent_tbl_column"></td>
                <td id="Total_tbl_column"></td>
            </tr>
            </table>

            <!-- slight break before autotext -->
            <p></p> 
            <div id="crime_top_bot_autotext_div" class="autotext" style="width: 600; height: 100; margin-left: auto; margin-right: auto; display: table;">&nbsp;</div>

            <script type="text/javascript" src="static/js/d3viz/crime_concentration_summary.js"></script>
            
            <h2 class="section-heading">Explore the City</h2>
            <ul>
                <li> Plot of crime versus income now and in past + diff
                <li> Geography graph
                <li> Auto text: Crime summary + change, race, income changes
            </ul>

            <table id="crime_archetype_tbl" cellpadding="5" class="d3axis tbl_container">
                <col width="250">
                <col width="350">
                <tr>
                <th class="archetype_name_tbl tbl_header" style="text-align: center;" colspan=2>Three Worlds in Chicago</th>
                </tr>
                <tr>
                <td id="affluents_arch_cell" class="archetype_selector_cell">
                    <div class="archetype_name_tbl">The Affluents</div>
                    <div class="archetype_description_tbl">Growing population of top-earners seeing the best improvements in crime and income</div>
                </td>
                    <td rowspan=3>
                        <svg width="350" height="350" id="crime_ineq_selected_map" style="margin-left: auto; margin-right: auto; display: block;"></svg>
                    </td>
                </tr>
                <tr><td id="working_arch_cell" class="archetype_selector_cell">
                    <div class="archetype_name_tbl">The Diverse Working Class</div>
                    <div class="archetype_description_tbl">Middle class of Chicago experiencing modest income and marked crime improvements</div>
                </td></tr>
                <tr><td id="distressed_arch_cell" class="archetype_selector_cell">
                    <div class="archetype_name_tbl">The Distressed</div>
                    <div class="archetype_description_tbl">Crime flat or decreasing slower than Chicago average with flat or decreasing incomes</div>
                </td></tr>
            </table>

            <!-- slight break before autotext -->
            <p></p> 
            
            <div id="archetype_autotext_div" class="autotext" style="width: 600; height: 200; margin-left: auto; margin-right: auto; display: table;">&nbsp;</div>

            <script type="text/javascript" src="static/js/d3viz/archetype.js"></script>

            <p>
            Something here explaining above. Below can see crime trends by neighborhood.
            </p>

            <svg width="600" height = "500" id="crime_chi_map_int_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <svg width="600" height = "300" id="crime_geo_detail_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <script type="text/javascript" src="static/js/d3viz/crime_intensity_map.js"></script>
            
            <h2 class="section-heading">Sizing Up a Crime</h2>
            <ul>
                <li> Discussion about how to look at crimes: severity of crime and per person 
                <li> Discuss data sourcing: intensity and population
                <li> table of crime intensity
                <li> discussion: what does intensity measure
                <li> Example of murder versus disorderly conduct of count versus weighted
                <li> How did I get weights
            </ul>


            <p></p>
            <svg width="600" height="600" id="crime_pct_severity_compare_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <script style="javascript">

function make_crime_method_compare() {

    var svg = d3.select("#crime_pct_severity_compare_svg")
        margin = {top: 20, right: 20, bottom: 20, left: 20},
        width = svg.attr("width") - margin.left - margin.right,
        height = svg.attr("height") - margin.top - margin.bottom,
        canvas = svg.append("g")
            .attr("transform", "translate(" + margin.left + ", " + margin.right + ")"),
        bubble_x_buffer = 10,
        bubble_y_buffer = 1,
        bubble_y_offset = height/3;

    var color = d3.scaleOrdinal(d3.schemeCategory10)

    var r = function(pct) { return width * Math.sqrt(pct) / 10; }
        y_ctr = function(type) { return (color.domain().findIndex(c => c == type) + 0.5) * bubble_y_offset; }

    // Draw
    d3.csv("static/data/recent_crime_ct_severity_stats.csv", function(csv_data) {

        color.domain(csv_data.map(d => d.crime_type));

        var nodes_generic = csv_data.map(function(d) {
            return {
                cluster         : d.crime_type,
                description     : d.crime_description,
                severity_pct    : +d.severity_pct,
                crime_count_pct : +d.crime_count_pct,
                r_severity      : r(+d.severity_pct),
                r_count         : r(+d.crime_count_pct)
            }
        }).sort(function(x, y) {
            return d3.descending(x.crime_count_pct, y.crime_count_pct);
        })


        var increment_x = (node1, node2) => Math.max(node1.r_severity + node2.r_severity, node1.r_count + node2.r_count) + bubble_x_buffer,
            last_node = color.domain().reduce(function(map, obj) {
                map[obj] = {x : 0, r_severity : 0, r_count : 0};
                return map;
            }, {});
            
        for(var i=0; i<nodes_generic.length; i++) {
            var ref = last_node[nodes_generic[i].cluster]

            nodes_generic[i].x = ref.x + increment_x(nodes_generic[i], ref);
            last_node[nodes_generic[i].cluster] = nodes_generic[i];
        }

        var pct_nodes = nodes_generic.map(function(old_d) {
                var d = Object.assign({}, old_d);
                d.y = y_ctr(d.cluster) - d.r_count - bubble_y_buffer;
                d.r = d.r_count;
                return d;
            }),
            sev_nodes = nodes_generic.map(function(old_d) {
                var d = Object.assign({}, old_d);
                d.y = y_ctr(d.cluster) + d.r_severity + bubble_y_buffer;
                d.r = d.r_severity;
                return d;
            }),
            nodes = pct_nodes.concat(sev_nodes)

        // Draw the circles
        canvas.append("g")
            .selectAll("circle")
            .data(nodes)
          .enter().append("circle")
            .style("fill", d => color(d.cluster))
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", d => d.r)
        // Label the circles
        canvas.append("g")
            .selectAll("text")
            .data(pct_nodes)
          .enter().append("text")
            .attr("class", "d3axis")
            .attr("alignment-baseline", "middle")
            .attr("transform", d => "translate(" + (d.x + d.r/1.4 + 4) + "," + (d.y - d.r/1.4 - 4) + ") rotate(-45)")
            .style("font-size", "12")
            .text(d => d.description)

        // Draw lines + descriptions
        var start_x = d3.min(nodes.map(d => d.x - d.r)),
            end_x = d3.max(nodes.map(d => d.x + d.r)) + 220,
            line_prep = color.domain().map(function(type) {
                return { cluster : type, y : y_ctr(type) };
            });
        canvas.append("g")
            .selectAll("line")
            .data(line_prep)
          .enter().append("line")
            .attr("x1", start_x).attr("x2", end_x)
            .attr("y1", d => d.y).attr("y2", d => d.y)
            .attr("stroke", "black")
            .attr("stroke-width", "1")
        // Label lines: category
        canvas.append("g")
            .selectAll("text")
            .data(line_prep)
          .enter().append("text")
            .attr("class", "d3axis")
            .attr("text-anchor", "middle")
            .attr("transform", d => "translate(0," + d.y + ") rotate(-90)")
            .text(d => d.cluster)
        // Label lines: count vs severity
        var wgt_type_label = canvas.append("g")
            .selectAll("text")
            .data(line_prep.filter(d => d.cluster == "Property"))
          .enter()
        wgt_type_label.append("text")
            .attr("class", "d3axis")
            .attr("transform", d=> "translate(" + end_x + "," + (d.y - 6) + ")")
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "baseline")
            .text("weighted by count")
        wgt_type_label.append("text")
            .attr("class", "d3axis")
            .attr("transform", d=> "translate(" + end_x + "," + (d.y + 6) + ")")
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "hanging")
            .text("weighted by crime sentencing")

    });

}

make_crime_method_compare();

            </script>

            <p></p>
            <table id="crime_bubble_parent_table" class="tbl_container" cellpadding="5">
                <tr>
                    <th colspan=2 style="text-align: center; border-bottom: 1.5px solid black;" class="d3axis tbl_header">Dark color &#8658; large discrepancy between naive- and severity-weighted</th>
                </tr>
                <tr>
                    <td style="text-align: center;" class="d3axis">Prevelance by count</td>
                    <td style="text-align: center;" class="d3axis">Prevelance by sentencing</td>
                </tr>
                <tr>
                    <td><svg width="300" height="225" id="crime_bubble_pct_svg" style="float: left"></svg></td>
                    <td><svg width="300" height="225" id="crime_bubble_severity_svg" style="float: right"></svg></td>
                </tr>
                <tr>
                    <td colspan=2><svg width="600" height="30" id="crime_bubble_type_key_svg"></svg></td>
                </tr>
            </table>
            <!-- slight break before autotext -->
            <p></p> 
            <div id="bubble_pct_hover_autotext_div" class="autotext" style="width: 600; height: 50; margin-left: auto; margin-right: auto; display: table;">&nbsp;</div>
            <p></p>

            <script style="text/javascript">

function make_crime_pct_bubble() {

    var parent_table = d3.select("#crime_bubble_parent_table"),
        svg = parent_table.select("#crime_bubble_pct_svg"),
        width = svg.attr("width"),
        height = svg.attr("height"),
        cluster_padding = height/20,
        pct_thresh = 0.005;

    var color = d3.scaleOrdinal(d3.schemeCategory10)

    function get_bubble_id(description) { return "bubble_crime_pct_" + description.replace(/\W/g, '') + "_id"; }

    function is_big_discrepancy(node) { 
        return Math.abs(2*(node.pct_severity - node.pct_count)/(node.pct_severity + node.pct_count)) > 0.75;
    } 

    function get_opacity(node) { 
        return is_big_discrepancy(node) ? "1" : "0.3"; 
    } 

    function get_nodes(csv_data, radius_field) {

        var nodes = csv_data.map(function(d) {
                var guess_x = width/2 + (Math.cos(color.domain().findIndex(c => c == d.crime_type) * 2 * Math.PI / color.domain().length) + (0.5 - Math.random())) * width * 0.2;
                    guess_y = width/2 + (Math.sin(color.domain().findIndex(c => c == d.crime_type) * 2 * Math.PI / color.domain().length) + (0.5 - Math.random())) * width * 0.2;
                    out = {
                        cluster      : d.crime_type,
                        description  : d.crime_description,
                        pct_severity : +d.severity_pct,
                        pct_count    : +d.crime_count_pct,
                        r            : Math.sqrt(+d[radius_field]) * width / 4,
                        x            : guess_x,
                        y            : guess_y
                    }
                return out;
            });

        return nodes;
    }

    function get_sim_update(svg_id, nodes) {
 
        function ticked() {

            var u = parent_table.selectAll(svg_id)
                .selectAll('circle')
                .data(nodes)

            u.enter().append('circle')
              .merge(u)
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)

            u.exit().remove()
        }

        return ticked;
    }
    
    // cluster captain force
    // from https://bl.ocks.org/mbostock/7881887
    function cluster() {
        
        var nodes,
            captains;
        
        function force(alpha) {
            
            nodes.forEach(function(d) {

                var captain = captains[d.cluster];
                if(captain === d) return;
                
                let x = d.x - captain.x,
                    y = d.y - captain.y,
                    l = Math.sqrt(x * x + y * y),
                    r = d.r + captain.r;

                if (l > r) {
                    l = (l - r) / l * alpha;
                    d.x -= x *= l;
                    d.y -= y *= l;
                    captain.x += x;
                    captain.y += y;
                }

            });
            
        }

        force.initialize = function (_) {
            nodes = _;
        }

        force.captains = _ => {
            captains = _ == null ? captains : _;
            return force;
        }

        return force;
    }

    function build_sim(svg_id, nodes) {

        // cluster captains
        var captains = {}
        for(var i=0; i<nodes.length; i++) {
            var node = nodes[i];
            if(!(node.cluster in captains)) {
                captains[node.cluster] = node;
            } else if(captains[node.cluster].r < node.r) {
                captains[node.cluster] = node;
            }
        }

        var simulation = d3.forceSimulation(nodes)
            .force("collision", d3.forceCollide().radius(d => d.r + 0.5).iterations(5))
            .force("charge", d3.forceManyBody().strength(height/15))
            .force("center", d3.forceCenter(width/2, height/2))
            .force("cluster", cluster().captains(captains))
            .on("tick", get_sim_update(svg_id, nodes));

        return simulation;
    
    }

    function drag_started(d, sim) {
        if (!d3.event.active) sim.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(d, sim) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }
    
    function drag_ended(d, sim) {
        if (!d3.event.active) sim.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    } 

    function initialize_bubbles(svg_id, nodes, sim) {

        parent_table.selectAll(svg_id)
            .selectAll("circle")
            .data(nodes)
          .enter().append("circle")
            .style("fill", d => color(d.cluster))
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", d => d.r)
            .attr("id", d => get_bubble_id(d.description))
            .style("opacity", get_opacity)
            .on("mouseover", function() {
                parent_table.selectAll("#" + this.id)
                    .transition()
                    .style("opacity", "1")
                    .style("fill", d3.color("red").darker())
                
                // update description
                var description = "<b>" + this.__data__.description + "</b>",
                    pct_count = "<b>" + Math.round(this.__data__.pct_count* 1000)/10 + "%</b>",
                    pct_sev= "<b>" + Math.round(this.__data__.pct_severity * 1000)/10 + "%</b>",
                    over_under_est = "<b>" + (this.__data__.pct_severity > this.__data__.pct_count ? "underestimating" : "overestimating") + "</b>"

                d3.select("#bubble_pct_hover_autotext_div")
                    .style("font-weight", null)
                    .style("text-align", null)
                    .style("color", "black")
                    .html(description + " is " + pct_count + " of crime by frequency, " + over_under_est + " the " + pct_sev + " share when accounting for severity")

            }).on("mouseout", function() {
                parent_table.selectAll("#" + this.id)
                    .transition()
                    .style("opacity", get_opacity)
                    .style("fill", d => color(d.cluster))

                // restore description
                d3.select("#bubble_pct_hover_autotext_div")
                    .style("font-weight", "bold")
                    .style("color", "Grey")
                    .style("text-align", "center")
                    .html("Hover over a bubble to compare")
            })
            .call(d3.drag()
                .on("start", d => drag_started(d, sim))
                .on("drag", d => dragged(d, sim))
                .on("end", d => drag_ended(d, sim))
            )
    }

    d3.csv("static/data/recent_crime_ct_severity_stats.csv", function(csv_data) {

        color.domain(csv_data.map(d => d.crime_type));

        // filter out irrelevant categories for this viz (i.e. too small to see)
        csv_data = csv_data.filter(d => d.severity_pct > pct_thresh || d.crime_count_pct > pct_thresh);

        var pct_nodes = get_nodes(csv_data, "crime_count_pct"),
            severity_nodes = get_nodes(csv_data, "severity_pct");

        // build the pct bubbles
        var pct_sim = build_sim("#crime_bubble_pct_svg", pct_nodes);
        initialize_bubbles("#crime_bubble_pct_svg", pct_nodes, pct_sim);

        // build the severity bubbles
        var sev_sim = build_sim("#crime_bubble_severity_svg", severity_nodes);
        initialize_bubbles("#crime_bubble_severity_svg", severity_nodes, sev_sim);

        // Make the crime type key
        var ordinal = d3.scaleOrdinal()
            .domain(color.domain())
            .range(color.range())

        var key_svg = parent_table.select("#crime_bubble_type_key_svg")
        
        key_svg.append("g")
            .attr("class", "legend_ordinal")

        var legend_ordinal = d3.legendColor()
            .scale(ordinal)
            .orient("horizontal")
            .shapePadding(80)

        key_svg.select(".legend_ordinal")
            .call(legend_ordinal)
       
        // place the labels where we want them 
        key_svg.selectAll(".legendCells")
            .selectAll(".label")
            .attr("transform", "translate(20, 12)")
            .attr("class", "d3axis")
            .style("text-anchor", null)

        // center the element
        var key_to_center = key_svg.selectAll(".legendCells"),
            key_width = key_to_center.node().getBBox().width,
            parent_width = key_svg.attr("width"),
            key_offset = (parent_width - key_width)/2;

        key_to_center.attr("transform", "translate(" + key_offset + ", 0)")

    })

    // initialize hover text
    d3.select("#bubble_pct_hover_autotext_div")
        .style("font-weight", "bold")
        .style("color", "Grey")
        .style("text-align", "center")
        .html("Hover over a bubble to compare")

}

make_crime_pct_bubble();

            </script>
            
            <h2 class="section-heading">Crime Overview</h2>
            <ul>
                <li> Rolling mean to avoid seasonality
                <li> Graph of total to category to FBI code name
                <li> Effects of income
                <li> Effects of race
            </ul>
            
            <h2 class="section-heading">Crime Inequality</h2>
            <ul>
                <li> How to determine inequality: who is impacted and geographic proxy
                <li> What is the Gini coefficient: top x% crime scroller
                <li> [Optional] Analysis of time of day?
            </ul>
            
            <h2 class="section-heading">Next Steps</h2>
            <ul>
                <li> Holistic measurements of wealth, including real estate value, foreclosures + how to source it
                <li> Relationship between crime and demographics change -- which populations are growing and shrinking? Which age groups? Which income levels?
                <li> Effects of education + how to source it
                <li> Better measurement of income + how to source it (IRS)
                <li> Get a better measure of crime severity + how to source it
            </ul>

            <h2 class="section-heading">Data Sources and Source Code</h2>
            <ul>
                <li> Link to github source
                <li> Explanations of major data sourcing
            </ul>
            
            <h2 class="section-heading">Related Work Investigating Crime in Chicago</h2>
            <ul>
                <li> <a href="http://crime.chicagotribune.com/">http://crime.chicagotribune.com/</a>
                <li> <a href="http://www.chicagohealthatlas.org/">http://www.chicagohealthatlas.org/</a>
                <li> <a href="http://convictions.smartchicagoapps.org/">http://convictions.smartchicagoapps.org/</a>
                <li> <a href="http://tableaupicasso.com/chicago-crime-scene/">http://tableaupicasso.com/chicago-crime-scene/</a>
            </ul>

<!--

            <blockquote>The dreams of yesterday are the hopes of today and the reality of tomorrow. Science has not yet mastered prophecy. We predict too much for the next year and yet far too little for the next ten.</blockquote>

            <a href="#">
              <img class="img-fluid" src="static/img/post-sample-image.jpg" alt="">
            </a>
            <span class="caption text-muted">To go places and do things that have never been done before – that’s what living is all about.</span>

            <p>Placeholder text by
              <a href="http://spaceipsum.com/">Space Ipsum</a>. Photographs by
              <a href="https://www.flickr.com/photos/nasacommons/">NASA on The Commons</a>.</p>
-->
          </div>
        </div>
      </div>
    </article>
{% endblock %}
