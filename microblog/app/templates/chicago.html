{% extends "base.html" %}
{% block content %}

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- for d3 legends -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <!-- for chromatic/cts color scale -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    
    <!-- Post Content -->
    <article>
      <div class="container">
        <div class="row">
          <!-- <div class="col-lg-8 col-md-10 mx-auto"> -->
          <div class="col-md-10 mx-auto">

<p style="color: red;">Dont forget to turn off debug flask</p>
<!-- TODO: migrate style touches! --> 
<style> 
.d3axis { font-size: 14px; font-weight: 300; }
</style>

<h2 class="section-heading">Summary</h2>

<p>
While crime in Chicago has generally decreased dramatically over the last 15 years, how is the progress distributed among the population? How is it distributed among the type of crime? These questions are the motivation for the investigations outlined below, where we analyze overall crime through time in the city, and how the "crime inequality" in the city as varied since the early 2000's.
<p>

<p>
We measure "Crime Intensity" in Chicago since 2002 broken into its major categories: Property Crime, Violent Crime, and Crime Against Society. We will soon elaborate more on "Crime Intensity", but for now think of it as:
</p>
 <blockquote style="text-align: center;">Crime Intensity = (# years served) / person if average prison sentence served in full for every crime reported</blockquote>

<p>
In line with the generally known reduction in crime, this analysis indeed shows a decline in crime by a marked 30% over the last 15 years (though there has also been a slight resurgence over the last few years). This is largely due to a decrease in Property Crime and Crimes against Society; Violent Crimes have remained closer to their 2002 levels. Feel free to explore the data in the figure below.
</p>

            <svg width="600" height="600" id="crime_type_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <script type="text/javascript" src="static/js/d3viz/crime_type_summary.js"></script>

<p>
However, while crime has fallen, it has not fallen uniformly throughout the city. In fact, those feeling the worst crime are feeling a higher fraction now than they have in the past. By looking at how crime is distributed geographically throughout the city, we can get a sense of how concentrated crime is over time. 
</p>

<p>
Again, the nature of this measurement will be elaborated below, but the signal can be seen when clearly looking at how much crime is felt by the worst quintie (worst 20%) as compared to the safest quintile. Among all crimes ("Total") since 2002, crime concentration among the worst areas went from 4.5x that of the safest areas to 5.5x. This was mainly driven by an increase in Property Crime concentration.
</p>

<p>
This can be explored in the figure below by clicking the different categories in the legend.
</p>
            
            <svg width="600" height="400" id="crime_worst_pct_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>

            <script type="text/javascript" src = "static/js/d3viz/crime_concentration_summary.js"></script>
            
            <h2 class="section-heading">Explore the City</h2>
            <ul>
                <li> Plot of crime versus income now and in past + diff
                <li> Geography graph
                <li> Auto text: Crime summary + change, race, income changes
            </ul>

            <svg width="600" height = "500" id="crime_geo_svg" style="margin-left: auto; margin-right: auto; display: block; shape-rendering: optimizeSpeed;"></svg>
            <svg width="600" height = "300" id="crime_geo_detail_svg" style="margin-left: auto; margin-right: auto; display: block; shape-rendering: optimizeSpeed;"></svg>
            <script type="text/javascript">

function explore_city_container() {

    var geo_svg = d3.select("#crime_geo_svg"),
        map_margin = {top: 60, right: 60},
        map_width = geo_svg.attr("width") - map_margin.right,
        map_height = geo_svg.attr("height") - map_margin.top;

    var map_color = d3.scaleSequential(d3.interpolateBlues);
    var color_saturate_factor = 0.6;

    // Begin map 2002/2017 selection
    function get_map_button_id(year) { return "map_button_" + year + "_id"; }

    geo_svg
        .append("g")
        .attr("class", "button_map");
    var map_button_scale_ordinal = d3.scaleOrdinal()
        .domain(["2002", "2017"])
        .range(["black", "black"]);
    var map_button_ordinal = d3.legendColor()
        .orient("horizontal")
        .labelOffset("-18")
        .shape("line")
        .shapeWidth("120")
        .scale(map_button_scale_ordinal)
        .on("cellclick", d => update_map(d));
    geo_svg.select(".button_map")
        .attr("class", "d3axis")
        .call(map_button_ordinal);
    // set legend id
    geo_svg.selectAll(".legendCells")
        .selectAll(".cell")
        .attr("id", d => get_map_button_id(d))
    // set line characteristics
    geo_svg.selectAll(".legendCells")
        .selectAll("line")
        .style("stroke-width", "5")
    // set offset
    var map_legend_width = geo_svg.select(".legendCells").node().getBBox().width;
    geo_svg.selectAll(".legendCells")
        .attr("transform", "translate(" +  (map_width - map_legend_width + map_margin.right)/2 + "," + map_margin.top/2 + ")")
    // End map 2002/2017 selection

    // Begin detail breakout declarations
    var timeParse = d3.timeParse("%Y-%m");
    var geo_detail_svg = d3.select("#crime_geo_detail_svg"),
        margin = {top: 90, right: 20, bottom: 60, left: 90},
        detail_width = geo_detail_svg.attr("width") - margin.left - margin.right,
        detail_height = geo_detail_svg.attr("height") - margin.top - margin.bottom,
        intensity_g = geo_detail_svg
            .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleTime().range([0, detail_width]),
        y = d3.scaleLinear().range([detail_height, 0])
        detail_color = d3.scaleOrdinal()
            .domain([0, 1])
            .range([d3.schemeCategory10[0], "black"]);

    var line = d3.line()
        .x(d => x(d.time))
        .y(d => y(d.crime_intensity));

    // Begin intensity detail legend
    intensity_g
        .append("g")
        .attr("class", "legend_intensity_detail");
    var detail_scale_ordinal = d3.scaleOrdinal()
        .domain(["Hyde Park", "Chicago"])
        .range(detail_color.range());
    var detail_legend_ordinal = d3.legendColor()
        .orient("horizontal")
        .labelOffset("-18")
        .shape("line")
        .shapeWidth("120")
        .scale(detail_scale_ordinal)
        .on("cellclick", d => update_plot_type(d));
    intensity_g.select(".legend_intensity_detail")
        .attr("class", "d3axis")
        .call(detail_legend_ordinal);
    // set legend id
    intensity_g.selectAll(".legendCells")
        .selectAll(".cell")
        .attr("id", "crime_detail_legend_id")
    // set line characteristics
    intensity_g.selectAll(".legendCells")
        .selectAll("line")
        .style("stroke-width", "5")
    // set offset
    var legend_width = intensity_g.select(".legendCells").node().getBBox().width;
    intensity_g.selectAll(".legendCells")
        .attr("transform", "translate(" +  (detail_width - legend_width)/2 + "," + -margin.top/3 + ")")
    // End Legend
    // End detail breakout declarations

    d3.json("static/data/chicago_geo.json", function(neighb_data) {

        var projection = d3.geoMercator()
            .fitExtent([[0, map_margin.top], [map_width, map_height + map_margin.top]], neighb_data);

        var path = d3.geoPath()
            .projection(projection);

        var color_scale_max = color_saturate_factor*d3.max(neighb_data.features.map(d => d.properties.crime_intensity_2002))

        map_color.domain([0, color_scale_max]);

        // draw the map
        geo_svg.append("g").selectAll("path")
            .data(neighb_data.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("stroke-width", "1")
            .attr("stroke", "black")
            .attr("fill", d => map_color(d.properties.crime_intensity_2017))
            .on("mouseover", function(d) { 
                d3.select(this)
                    .transition()
                    .attr("fill", d3.color("red").darker());
                update_city_detail(d.properties.community);
            }).on("mouseout", function(d) {
                d3.select(this)
                    .transition()
                    .attr("fill", d => map_color(d.properties.crime_intensity_2017));
            });

        update_map("2017"); // act as initializer

        // draw gradient legend
        /*
        var map_legend_w = map_margin.right, 
            map_legend_h = map_height;
        var map_key = geo_svg.append("svg")
            .attr("width", map_legend_w)
            .attr("height", map_legend_h);
        var map_legend = map_key
            .append("defs").append("svg:linearGradient").attr("id", "map_legend_gradient").attr("x1", "100%").attr("y1", "0%").attr("x2", "100%").attr("y2", "100%").attr("spreadMethod", "pad");
        map_legend.append("stop").attr("offset", "0%").attr("stop-color", "#B30000").attr("stop-opacity", 1);
        map_legend.append("stop").attr("offset", "100%").attr("stop-color", "#FEE8c8").attr("stop-opacity", 1);
        map_key.append("rect").attr("width", map_legend_w).attr("height", map_legend_h).style("fill", "url(#gradient)").attr("transform", "translate(0,10)");
        var map_legend_y = d3.scale.linear().range([300, 0]).domain([1, 100]);
        var map_legend_yAxis = d3.svg.axis().scale(map_legend_y).orient("right");
        map_legend_key.append("g").attr("class", "map_legend_y axis").attr("transform", "translate(41,10)").call(map_legend_yAxis).append("text").attr("transform", "rotate(-90)").attr("y", 30).attr("dy", ".71em").style("text-anchor", "end").text("axis title");
        */

        // initialize the detail graph
        d3.csv('static/data/neighb_intensity/HYDE PARK_intensity.csv', function(csv_data) {

            var parsed_data = [[], []]
            csv_data.forEach(function(row) { 
                row.time = timeParse(row.time);
                row.neighb_crime_intensity = +row.neighb_crime_intensity;
                row.city_crime_intensity = +row.city_crime_intensity;
                parsed_data[0].push({"time" : row.time, "crime_intensity" : row.neighb_crime_intensity});
                parsed_data[1].push({"time" : row.time, "crime_intensity" : row.city_crime_intensity});
            });
            
            x.domain(d3.extent(csv_data.map(d => d.time)));
            y.domain([0, d3.max([d3.max(parsed_data[0], d => d.crime_intensity), d3.max(parsed_data[1], d => d.crime_intensity)])]);

            // begin plot axes
            intensity_g.append("g")
                .attr("class", "d3axis")
                .attr("transform", "translate(0," + detail_height + ")")
                .attr("id", "intensity_detail_x_axis")
                .call(d3.axisBottom(x).ticks(3))
                .append("text")
                .attr("text-anchor", "middle")
                .attr("transform", "translate(" + detail_width/2.0 + "," + 2*margin.bottom/3 + ")")
                .attr("fill", "black")
                .text("time");

            intensity_g.append("g")
                .attr("class", "d3axis")
                .attr("id", "intensity_detail_y_axis")
                .call(d3.axisLeft(y).ticks(3))
                .append("text")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left/2)
                .attr("x", -detail_height/2)
                .attr("transform", "rotate(-90)")
                .attr("fill", "black")
                .text("Crime intensity");
            // end plot axes

            intensity_g.selectAll("svg")
                .data(parsed_data)
                .enter()
                .append("g")
                .attr("id", "intensity_detail_line")
                .append("path")
                .attr("d", d => line(d))
                .attr("fill", "none")
                .attr("stroke", function(d, i) { return detail_color(i); })
                .attr("stroke-width", "2");
            
        });

    });

    function update_map(year) {

        var legend_cells = geo_svg.selectAll(".legendCells").transition();
        var target_button = geo_svg.selectAll("#" + get_map_button_id(year)).transition();

        // update buttons -- reset
        legend_cells.selectAll("line")
            .style("opacity", "0.5");
        legend_cells.selectAll("text")
            .style("font-weight", null);

        // update buttons -- select one and highlight
        target_button.selectAll("line")
            .style("opacity", "1.0");
        target_button.selectAll("text")
            .style("font-weight", "bold");

        // update graph
        geo_svg.selectAll("path").transition()
            .attr("fill", d => map_color(d.properties["crime_intensity_" + year]))
    }

    function update_city_detail(neighb) {

        // Update data
        d3.csv('static/data/neighb_intensity/' + neighb + '_intensity.csv', function(csv_data) {
            
            var parsed_data = [[], []]
            csv_data.forEach(function(row) { 
                row.time = timeParse(row.time);
                row.neighb_crime_intensity = +row.neighb_crime_intensity;
                row.city_crime_intensity = +row.city_crime_intensity;
                parsed_data[0].push({"time" : row.time, "crime_intensity" : row.neighb_crime_intensity});
                parsed_data[1].push({"time" : row.time, "crime_intensity" : row.city_crime_intensity});
            });

            x.domain(d3.extent(csv_data.map(d => d.time)));
            y.domain([0, d3.max([d3.max(parsed_data[0], d => d.crime_intensity), d3.max(parsed_data[1], d => d.crime_intensity)])]);

            // Begin update axes
            intensity_g.select("#intensity_detail_x_axis")
                .transition()
                .call(d3.axisBottom(x).ticks(3))
           
            intensity_g.select("#intensity_detail_y_axis")
                .transition()
                .call(d3.axisLeft(y).ticks(3))
            // End update axes
            
            // begin plot each crime type over time
            var svg_temp = intensity_g
                .selectAll("#intensity_detail_line")
                .selectAll("path")
                .data(parsed_data)

            svg_temp
                .enter()
                .append("path")
                .merge(svg_temp)
                .transition()
                .attr("d", d => line(d))
                .attr("fill", "none")
                .attr("stroke", function(d, i) { return detail_color(i); })
                .attr("stroke-width", "2");

            svg_temp.exit().remove();
            // end plot each crime type over time

            // update the legend
            intensity_g.select(".legendCells")
                .select("text")
                .style("text-transform", "capitalize")
                .text(neighb.toLowerCase())
        });
    }

}

explore_city_container();

            </script>

            <h2 class="section-heading">Sizing Up a Crime</h2>
            <ul>
                <li> Discussion about how to look at crimes: severity of crime and per person 
                <li> Discuss data sourcing: intensity and population
                <li> table of crime intensity
                <li> discussion: what does intensity measure
                <li> Example of murder versus disorderly conduct of count versus weighted
                <li> How did I get weights
            </ul>
            
            <h2 class="section-heading">Crime Overview</h2>
            <ul>
                <li> Rolling mean to avoid seasonality
                <li> Graph of total to category to FBI code name
                <li> Effects of income
                <li> Effects of race
            </ul>
            
            <h2 class="section-heading">Crime Inequality</h2>
            <ul>
                <li> How to determine inequality: who is impacted and geographic proxy
                <li> What is the Gini coefficient: top x% crime scroller
                <li> [Optional] Analysis of time of day?
            </ul>
            
            <h2 class="section-heading">Next Steps</h2>
            <ul>
                <li> Holistic measurements of wealth, including real estate value, foreclosures + how to source it
                <li> Effects of education + how to source it
                <li> Better measurement of income + how to source it (IRS)
                <li> Get a better measure of crime severity + how to source it
            </ul>

            <h2 class="section-heading">Data Sources and Source Code</h2>
            <ul>
                <li> Link to github source
                <li> Explanations of major data sourcing
            </ul>
            
            <h2 class="section-heading">Related Work Investigating Crime in Chicago</h2>
            <ul>
                <li> <a href="http://crime.chicagotribune.com/">http://crime.chicagotribune.com/</a>
                <li> <a href="http://www.chicagohealthatlas.org/">http://www.chicagohealthatlas.org/</a>
                <li> <a href="http://convictions.smartchicagoapps.org/">http://convictions.smartchicagoapps.org/</a>
                <li> <a href="http://tableaupicasso.com/chicago-crime-scene/">http://tableaupicasso.com/chicago-crime-scene/</a>
            </ul>

<!--

            <blockquote>The dreams of yesterday are the hopes of today and the reality of tomorrow. Science has not yet mastered prophecy. We predict too much for the next year and yet far too little for the next ten.</blockquote>

            <a href="#">
              <img class="img-fluid" src="static/img/post-sample-image.jpg" alt="">
            </a>
            <span class="caption text-muted">To go places and do things that have never been done before – that’s what living is all about.</span>

            <p>Placeholder text by
              <a href="http://spaceipsum.com/">Space Ipsum</a>. Photographs by
              <a href="https://www.flickr.com/photos/nasacommons/">NASA on The Commons</a>.</p>
-->
          </div>
        </div>
      </div>
    </article>
{% endblock %}
