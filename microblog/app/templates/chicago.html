{% extends "base.html" %}
{% block content %}

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- for d3 legends -->
    <!--
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    -->

    <!-- Post Content -->
    <article>
      <div class="container">
        <div class="row">
          <!-- <div class="col-lg-8 col-md-10 mx-auto"> -->
          <div class="col-md-10 mx-auto">

<p>Dont forget to turn off debug flask</p>
<!-- TODO: migrate style touches! --> 
<style> 
.d3axis { font-size: 14px; font-weight: 300; }
</style>


            <h2 class="section-heading">Summary</h2>

<p>
While crime in Chicago has generally decreased dramatically over the last 15 years, how is the progress distributed among the population? How is it distributed among the type of crime? These questions are the motivation for the investigations outlined below, where we analyze overall crime through time in the city, and how the "crime inequality" in the city as varied since the early 2000's.
<p>

<p>
In line with the general understanding of recent crime reduction, we indeed see a decline in crime by a marked 30% over the last 15 years (though there has also been a slight resurgence over the last few years). In the figure below, we show the "crime intensity" for the 3 major crime types: crimes against Property, Violent crimes, and crimes against Society. Subesequent breakdowns can be seen by hovering your cursor over a type. We soon will elaborate more on the "crime intensity", but for now think of it as a measurement of how many years would be served per person per year if the average prison sentence was served in full for each crime committed.
</p>

            <svg width="600" height="600" id="crime_type_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>
            <script type="text/javascript" src="static/js/d3viz/crime_type_summary.js"></script>

<p>
However, while crime has fallen, it has not fallen uniformly throughout the city. In fact, those feeling the worst crime are feeling a higher fraction now than they have in the past. By looking at how crime is distributed geographically throughout the city, we can get a sense of how concentrated crime is over time. 
</p>

<p>
Again, this will be elaborated below, but the clear signal can be seen when looking at how much crime is felt by the worst 20%. Among all crimes ("Total") since 2002, crime concentration among the worst 20% went from 37% of all crime to 42%. See the figure below how crime concentration among this top 20% has changed among the major crime categories.
</p>

<p style="color: red;">
Show worst compared to best instead? 
</p>

            <svg width="600" height="300" id="crime_worst_pct_svg" style="margin-left: auto; margin-right: auto; display: block;"></svg>

            <script type="text/javascript">

function make_crime_concentration() {

    var crime_type_svg = d3.select("#crime_worst_pct_svg"),
        margin = {top: 20, right: 20, bottom: 60, left: 110},
        width = crime_type_svg.attr("width") - margin.left - margin.right,
        height = crime_type_svg.attr("height") - margin.top - margin.bottom,
        crime_type_g = crime_type_svg
            .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleTime().range([0, width]),
        y = d3.scaleLinear().range([height, 0]),
        z = d3.scaleOrdinal(d3.schemeCategory10);        

    var line = d3.line()
        .x(d => x(d.time))
        .y(d => y(d.total_crime_pct));
        
    var timeParse = d3.timeParse("%Y-%m");

    d3.csv("static/data/chicago_crime_top_20_pct.csv", function(csv_data) {
        
        csv_data.forEach(function(row) { 
            row.time = timeParse(row.time);
            row.total_crime_pct = +row.total_crime_pct;
        })

        var worst_pct_nest = d3.nest()
            .key(d => d.crime_type)
            .entries(csv_data);
        
        // loop over each crime type and find the one that hadn the highest concentration
        var highest_crime_concentration = d3.max(
            worst_pct_nest.map(type => d3.max(
                type.values.map(d => d.total_crime_pct)
            ))
        );
        
        x.domain(d3.extent(worst_pct_nest[0].values.map(d => d.time)))
        y.domain([0.3, highest_crime_concentration]);
        z.domain(worst_pct_nest.map(d => d.key));

        // Begin make axes
        crime_type_g.append("g")
            .attr("class", "d3axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x)
                .tickFormat(d3.timeFormat("%Y-%m"))
            )
            .call(d3.axisBottom(x))
            .append("text")
            .attr("text-anchor", "middle")
            .attr("transform", "translate(" + (width/2.0) + "," + 2*margin.bottom/3 + ")")
            .attr("fill", "black")
            .text("time");
       
        crime_type_g.append("g")
            .attr("class", "d3axis")
            .call(d3.axisLeft(y).ticks(4))
            .append("text")
            .attr("text-anchor", "middle")
            .attr("y", -margin.left/2)
            .attr("x", -height/2)
            .attr("transform", "rotate(-90)")
            .attr("fill", "black")
            .text("Fraction of crime in worst 20%");
        // End make axes
        
        // begin plot each crime type over time
        // Data
        crime_type_g.selectAll("svg")
            .data(worst_pct_nest)
            .enter()
            .append("path")
            .attr("d", d => line(d.values))
            .attr("fill", "none")
            .attr("stroke", d => z(d.key))
            .style("stroke-width", "2");

        // Text above
        crime_type_g.selectAll("svg")
            .data(worst_pct_nest)
            .enter()
            .append("text")
            .attr("class", "d3axis")
            .attr("x", 6)
            .attr("y", d => y(d.values[0].total_crime_pct) - 8)
            .text(d => d.key);
        // end plot each crime type over time

        // begin mouseover pct crime
        /*
        crime_type_g.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
        */
        // end mouseover pct crime
    });

}

make_crime_concentration();

            </script>

            <h2 class="section-heading">Sizing Up a Crime</h2>
            <ul>
                <li> Discussion about how to look at crimes: severity of crime and per person 
                <li> Discuss data sourcing: intensity and population
                <li> table of crime intensity
                <li> discussion: what does intensity measure
                <li> Example of murder versus disorderly conduct of count versus weighted
                <li> How did I get weights
            </ul>
            
            <h2 class="section-heading">Crime Overview</h2>
            <ul>
                <li> Rolling mean to avoid seasonality
                <li> Graph of total to category to FBI code name
                <li> Effects of income
                <li> Effects of race
            </ul>
            
            <h2 class="section-heading">Crime Inequality</h2>
            <ul>
                <li> How to determine inequality: who is impacted and geographic proxy
                <li> What is the Gini coefficient: top x% crime scroller
                <li> [Optional] Analysis of time of day?
            </ul>
            
            <h2 class="section-heading">Explore the City</h2>
            <ul>
                <li> Plot of crime versus income now and in past + diff
                <li> Geography graph
                <li> Auto text: Crime summary + change, race, income changes
            </ul>
            
            <h2 class="section-heading">Next Steps</h2>
            <ul>
                <li> Holistic measurements of wealth, including real estate value, foreclosures + how to source it
                <li> Effects of education + how to source it
                <li> Better measurement of income + how to source it (IRS)
                <li> Get a better measure of crime severity + how to source it
            </ul>

            <h2 class="section-heading">Data Sources and Source Code</h2>
            <ul>
                <li> Hey
            </ul>
            
            <h2 class="section-heading">Related Work by Others</h2>
            <ul>
                <li> Hey
            </ul>


            <blockquote>The dreams of yesterday are the hopes of today and the reality of tomorrow. Science has not yet mastered prophecy. We predict too much for the next year and yet far too little for the next ten.</blockquote>

            <a href="#">
              <img class="img-fluid" src="static/img/post-sample-image.jpg" alt="">
            </a>
            <span class="caption text-muted">To go places and do things that have never been done before – that’s what living is all about.</span>

            <p>Placeholder text by
              <a href="http://spaceipsum.com/">Space Ipsum</a>. Photographs by
              <a href="https://www.flickr.com/photos/nasacommons/">NASA on The Commons</a>.</p>
          </div>
        </div>
      </div>
    </article>
{% endblock %}
