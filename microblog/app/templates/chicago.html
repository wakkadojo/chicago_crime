{% extends "base.html" %}
{% block content %}

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- for d3 legends -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>

    <!-- Post Content -->
    <article>
      <div class="container">
        <div class="row">
          <!-- <div class="col-lg-8 col-md-10 mx-auto"> -->
          <div class="col-md-10 mx-auto">

            <p>Dont forget to turn off debug flask</p>

            <h2 class="section-heading">Summary</h2>
            <ul>
                <li> Crime has come down across the city
                <li> While crime has come down, the inequality has noticeably increased
            </ul>

<svg width="600" height="300"></svg>

<style> 
.d3axis { font-size: 14px; font-weight: 300; }
</style>

<script type="text/javascript">

    var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 60, left: 110},
        width = svg.attr("width") - margin.left - margin.right,
        height = svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleTime().range([0, width]),
        y = d3.scaleLinear().range([height, 0]),
        z = d3.scaleOrdinal(d3.schemeCategory10);        
        
    var area = d3.area()
        .x(d => x(d.data.time))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]))
        .defined(d => d.data.time.getFullYear() > 2001)

    var line = d3.line()
        .x(d => x(d.key))
        .y(d => y(+d.value))
        .defined(d => d.value != 0)

    var timeParse = d3.timeParse("%Y-%m");

    var get_crime_type_line_id   = function(type) { return type + "_type_line"; }
        get_crime_type_area_id   = function(type) { return type + "_type_area"; }
        get_crime_type_legend_id = function(type) { return type + "_type_legend"; }

    var crime_type_mouseover = function(type) {
        d3.select("#" + get_crime_type_area_id(type)).style("opacity", "1");
        d3.select("#" + get_crime_type_legend_id(type)).select("text").style("font-weight", "bold");
        d3.select("#" + get_crime_type_legend_id(type)).select("rect").style("opacity", "1");
    }

    var crime_type_mouseout = function(type) {
        d3.select("#" + get_crime_type_area_id(type)).style("opacity", "0.4");
        d3.select("#" + get_crime_type_legend_id(type)).select("text").style("font-weight", null);
        d3.select("#" + get_crime_type_legend_id(type)).select("rect").style("opacity", "0.4");
    }

    d3.csv("static/data/chicago_crimes_percapita.csv", function(csv_data) {

        csv_data.forEach(function(d) { 
            d.time = d.time // Do not parse here: if we do nest turns it back to str anyway, parse later
            d.crime_intensity = d.crime_intensity == "" ? null : +d.crime_intensity;
        })

        var type_nest = d3.nest()
            .key(d => d.crime_type)
            .key(d => d.time)
            .rollup(leaves =>
                d3.sum(leaves, d => d.crime_intensity)
            )
            .entries(csv_data);

        // After grouping, convert string dates we grouped on to datetime objects
        type_nest.forEach(function(type) {
            type.values.forEach(function(d) {
                d.key = timeParse(d.key)
            })
        })

        var type_flat = type_nest[0].values.map(function(d, i) {
            var time_point_dict = {}
            time_point_dict["time"] = type_nest[0].values[i].key;
            type_nest.forEach(function(d) {
                time_point_dict[d.key] = d.values[i].value;
            })
            return time_point_dict;
        })

        var type_stack_gen = d3.stack()
            .keys(type_nest.map(d => d.key));

        var type_stack = type_stack_gen(type_flat);

        //x.domain(d3.extent(type_nest[0].values, d => d.key));
        //y.domain([0, d3.max(type_nest[0].values, d => d.value)]);
        x.domain(d3.extent(type_stack[0].filter(d => d.data.time.getFullYear() > 2001).map(d => d.data.time)));
        y.domain([0, d3.max(type_stack[type_stack.length - 1].map(d => d[1]))]);
        z.domain(type_nest.map(type => type.key));

        // Begin make legend
        var ordinal_legend_entries = d3.scaleOrdinal()
            .domain(type_nest.map(type => type.key))
            .range(type_nest.map(type => z(type.key)))

        var legend = g.append("g")
            .attr("class", "legend_ordinal")
            .attr("transform", "translate(" + (width - margin.right - 80) + "," + margin.top/2 + ")")

        var legend_ordinal = d3.legendColor()
            .scale(ordinal_legend_entries)
            .on("cellover", function() { 
                var type = d3.select(this).text();
                crime_type_mouseover(type);
            })
            .on("cellout", function() {
                var type = d3.select(this).text();
                crime_type_mouseout(type);
            });


        g.select(".legend_ordinal")
            .attr("class", "d3axis")
            .call(legend_ordinal);
        
        // After we make the class lets add tags to the labels and also specify opacity
        d3.selectAll(".legendCells").selectAll(".cell").each(function() {
            // id
            var type = d3.select(this).select("text").text();
            d3.select(this).attr("id", get_crime_type_legend_id(type));
            // swatch
            d3.select(this).select("rect").style("opacity", "0.4");
        });
        // End make legend

        // Begin make axes
        g.append("g")
            .attr("class", "d3axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x)
                .tickFormat(d3.timeFormat("%Y-%m"))
            )
            .call(d3.axisBottom(x))
            .append("text")
            .attr("text-anchor", "middle")
            .attr("transform", "translate(" + (width/2.0) + "," + 2*margin.bottom/3 + ")")
            .attr("fill", "black")
            .text("time");
       
        g.append("g")
            .attr("class", "d3axis")
            .call(d3.axisLeft(y).ticks(4))
            .append("text")
            .attr("text-anchor", "middle")
            .attr("y", -margin.left/2)
            .attr("x", -height/2)
            .attr("transform", "rotate(-90)")
            .attr("fill", "black")
            .text("crime intensity");
        // End make axes

        // begin plot each crime type over time
        g.selectAll("svg")
            .data(type_stack)
            .enter()
            .append("path")
            .data(type_stack)
            .attr("d", d => area(d))
            .attr("id", d => get_crime_type_area_id(d.key))
            .style("fill", d => z(d.key))
            .style("opacity", "0.4")
            .on("mouseover", function(d) { crime_type_mouseover(d.key); })
            .on("mouseout", function(d) { crime_type_mouseout(d.key); });
        // end plot each crime type over time

        // Below is older non-stacked plot
        /*
        type_nest.forEach(function(type) {

            var data = type.values
            var key = type.key

            g.append("path")
                .datum(data)
                .attr("id", get_crime_type_line_id(key))
                .attr("d", line)
                .style("stroke-width", "1.25")
                .style("stroke", z(key))
                .attr("fill", "none")
                .on("mouseover", function() { crime_type_mouseover(key); })
                .on("mouseout", function() { crime_type_mouseout(key); });

        })
        */

    });

</script>

            <h2 class="section-heading">Sizing Up a Crime</h2>
            <ul>
                <li> Discussion about how to look at crimes: severity of crime and per person 
                <li> Discuss data sourcing: intensity and population
                <li> table of crime intensity
                <li> discussion: what does intensity measure
                <li> Example of murder versus disorderly conduct of count versus weighted
                <li> How did I get weights
            </ul>
            
            <h2 class="section-heading">Crime Overview</h2>
            <ul>
                <li> Rolling mean to avoid seasonality
                <li> Graph of total to category to FBI code name
                <li> Effects of income
                <li> Effects of race
            </ul>
            
            <h2 class="section-heading">Crime Inequality</h2>
            <ul>
                <li> How to determine inequality: who is impacted and geographic proxy
                <li> What is the Gini coefficient: top x% crime scroller
                <li> [Optional] Analysis of time of day?
            </ul>
            
            <h2 class="section-heading">Explore the City</h2>
            <ul>
                <li> Plot of crime versus income now and in past + diff
                <li> Geography graph
                <li> Auto text: Crime summary + change, race, income changes
            </ul>
            
            <h2 class="section-heading">Next Steps</h2>
            <ul>
                <li> Holistic measurements of wealth, including real estate value, foreclosures + how to source it
                <li> Effects of education + how to source it
                <li> Better measurement of income + how to source it (IRS)
                <li> Get a better measure of crime severity + how to source it
            </ul>

            <h2 class="section-heading">Data Sources and Source Code</h2>
            <ul>
                <li> Hey
            </ul>
            
            <h2 class="section-heading">Related Work by Others</h2>
            <ul>
                <li> Hey
            </ul>


            <blockquote>The dreams of yesterday are the hopes of today and the reality of tomorrow. Science has not yet mastered prophecy. We predict too much for the next year and yet far too little for the next ten.</blockquote>

            <a href="#">
              <img class="img-fluid" src="static/img/post-sample-image.jpg" alt="">
            </a>
            <span class="caption text-muted">To go places and do things that have never been done before – that’s what living is all about.</span>

            <p>Placeholder text by
              <a href="http://spaceipsum.com/">Space Ipsum</a>. Photographs by
              <a href="https://www.flickr.com/photos/nasacommons/">NASA on The Commons</a>.</p>
          </div>
        </div>
      </div>
    </article>
{% endblock %}
